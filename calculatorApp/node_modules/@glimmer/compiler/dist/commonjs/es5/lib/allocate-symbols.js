"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.SymbolAllocator = undefined;

var _util = require("@glimmer/util");

var _createClass = function () {
    function defineProperties(target, props) {
        for (var i = 0; i < props.length; i++) {
            var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ("value" in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);
        }
    }return function (Constructor, protoProps, staticProps) {
        if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;
    };
}();

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function");
    }
}

var SymbolAllocator = exports.SymbolAllocator = function () {
    function SymbolAllocator(ops) {
        _classCallCheck(this, SymbolAllocator);

        this.ops = ops;
        this.symbolStack = new _util.Stack();
    }

    SymbolAllocator.prototype.process = function process() {
        var out = [];
        var ops = this.ops;

        for (var i = 0; i < ops.length; i++) {
            var op = ops[i];
            var result = this.dispatch(op);
            if (result === undefined) {
                out.push(op);
            } else {
                out.push(result);
            }
        }
        return out;
    };

    SymbolAllocator.prototype.dispatch = function dispatch(op) {
        var name = op[0];
        var operand = op[1];
        return this[name](operand);
    };

    SymbolAllocator.prototype.startProgram = function startProgram(op) {
        this.symbolStack.push(op['symbols']);
    };

    SymbolAllocator.prototype.endProgram = function endProgram(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.startBlock = function startBlock(op) {
        this.symbolStack.push(op['symbols']);
    };

    SymbolAllocator.prototype.endBlock = function endBlock(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.flushElement = function flushElement(op) {
        this.symbolStack.push(op['symbols']);
    };

    SymbolAllocator.prototype.closeElement = function closeElement(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.closeComponent = function closeComponent(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.closeDynamicComponent = function closeDynamicComponent(_op) {
        this.symbolStack.pop();
    };

    SymbolAllocator.prototype.attrSplat = function attrSplat(_op) {
        return ['attrSplat', this.symbols.allocateBlock('attrs')];
    };

    SymbolAllocator.prototype.get = function get(op) {
        var name = op[0],
            rest = op[1];

        if (name === 0) {
            return ['get', [0, rest]];
        }
        if (isLocal(name, this.symbols)) {
            var head = this.symbols.get(name);
            return ['get', [head, rest]];
        } else if (name[0] === '@') {
            var _head = this.symbols.allocateNamed(name);
            return ['get', [_head, rest]];
        } else {
            return ['maybeLocal', [name].concat(rest)];
        }
    };

    SymbolAllocator.prototype.maybeGet = function maybeGet(op) {
        var name = op[0],
            rest = op[1];

        if (name === 0) {
            return ['get', [0, rest]];
        }
        if (isLocal(name, this.symbols)) {
            var head = this.symbols.get(name);
            return ['get', [head, rest]];
        } else if (name[0] === '@') {
            var _head2 = this.symbols.allocateNamed(name);
            return ['get', [_head2, rest]];
        } else if (rest.length === 0) {
            return ['unknown', name];
        } else {
            return ['maybeLocal', [name].concat(rest)];
        }
    };

    SymbolAllocator.prototype.yield = function _yield(op) {
        if (op === 0) {
            throw new Error('Cannot yield to this');
        }
        return ['yield', this.symbols.allocateBlock(op)];
    };

    SymbolAllocator.prototype.debugger = function _debugger(_op) {
        return ['debugger', this.symbols.getEvalInfo()];
    };

    SymbolAllocator.prototype.hasBlock = function hasBlock(op) {
        if (op === 0) {
            throw new Error('Cannot hasBlock this');
        }
        return ['hasBlock', this.symbols.allocateBlock(op)];
    };

    SymbolAllocator.prototype.hasBlockParams = function hasBlockParams(op) {
        if (op === 0) {
            throw new Error('Cannot hasBlockParams this');
        }
        return ['hasBlockParams', this.symbols.allocateBlock(op)];
    };

    SymbolAllocator.prototype.partial = function partial(_op) {
        return ['partial', this.symbols.getEvalInfo()];
    };

    SymbolAllocator.prototype.text = function text(_op) {};

    SymbolAllocator.prototype.comment = function comment(_op) {};

    SymbolAllocator.prototype.openComponent = function openComponent(_op) {};

    SymbolAllocator.prototype.openElement = function openElement(_op) {};

    SymbolAllocator.prototype.staticArg = function staticArg(_op) {};

    SymbolAllocator.prototype.dynamicArg = function dynamicArg(_op) {};

    SymbolAllocator.prototype.staticAttr = function staticAttr(_op) {};

    SymbolAllocator.prototype.trustingAttr = function trustingAttr(_op) {};

    SymbolAllocator.prototype.trustingComponentAttr = function trustingComponentAttr(_op) {};

    SymbolAllocator.prototype.dynamicAttr = function dynamicAttr(_op) {};

    SymbolAllocator.prototype.componentAttr = function componentAttr(_op) {};

    SymbolAllocator.prototype.modifier = function modifier(_op) {};

    SymbolAllocator.prototype.append = function append(_op) {};

    SymbolAllocator.prototype.block = function block(_op) {};

    SymbolAllocator.prototype.literal = function literal(_op) {};

    SymbolAllocator.prototype.helper = function helper(_op) {};

    SymbolAllocator.prototype.unknown = function unknown(_op) {};

    SymbolAllocator.prototype.maybeLocal = function maybeLocal(_op) {};

    SymbolAllocator.prototype.prepareArray = function prepareArray(_op) {};

    SymbolAllocator.prototype.prepareObject = function prepareObject(_op) {};

    SymbolAllocator.prototype.concat = function concat(_op) {};

    _createClass(SymbolAllocator, [{
        key: 'symbols',
        get: function get() {
            return this.symbolStack.current;
        }
    }]);

    return SymbolAllocator;
}();
function isLocal(name, symbols) {
    return symbols && symbols.has(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsb2NhdGUtc3ltYm9scy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9hbGxvY2F0ZS1zeW1ib2xzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFHQSxBQUFPLEFBQUUsQUFBSyxBQUFFLEFBQU0sQUFBRSxBQUFNLEFBQWUsQUFBQyxBQWlCOUMsQUFBTTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBQU8sQUFBZSxBQUkxQjs2QkFBb0IsQUFBZ0IsS0FBaEI7OzthQUFHLE1BRmYsQUFFWSxBQUFHLEFBQWE7YUFGakIsY0FBRyxBQUFJLEFBQUssQUFBZSxBQUFDLEFBRVIsQUFBQyxBQUV4QyxBQUFPOzs7O1lBQ0QsQUFBRyxNQUFZLEFBQUUsQUFBQyxBQUN0QixBQUFJLEFBREo7WUFDTSxBQUFHLEFBQUUsTUFBRyxBQUFJLEFBQUMsQUFFbkI7O2FBQUssSUFBSSxBQUFDLElBQUcsQUFBQyxHQUFFLEFBQUMsSUFBRyxBQUFHLElBQUMsQUFBTSxRQUFFLEFBQUMsQUFBRSxLQUFFLEFBQ25DO2dCQUFJLEFBQUUsS0FBRyxBQUFHLElBQUMsQUFBQyxBQUFDLEFBQUMsQUFDaEI7Z0JBQUksQUFBTSxTQUFHLEFBQUksS0FBQyxBQUFRLFNBQUMsQUFBRSxBQUFDLEFBQUMsQUFFL0I7Z0JBQUksQUFBTSxXQUFLLEFBQVMsV0FBRSxBQUN4QixBQUFHO29CQUFDLEFBQUksS0FBQyxBQUFXLEFBQUMsQUFBQyxBQUN2QjttQkFBTSxBQUNMLEFBQUc7b0JBQUMsQUFBSSxLQUFDLEFBQWEsQUFBQyxBQUFDLEFBQ3pCLEFBQ0Y7QUFFRDs7ZUFBTyxBQUFHLEFBQUMsQUFDYixBQUFDLEFBRUQsQUFBUTs7OzJEQUFpQixBQUFLLElBQzVCO1lBQUksQUFBSSxPQUFHLEFBQUUsR0FBQyxBQUFDLEFBQUMsQUFBQyxBQUNqQjtZQUFJLEFBQU8sVUFBRyxBQUFFLEdBQUMsQUFBQyxBQUFDLEFB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WTs7bUVBQUMsQUFBVyxLQUFHLEFBQUMsQUFDNUIsQUFBYTs7cUVBQUMsQUFBVyxLQUFHLEFBQUMsQUFDN0IsQUFBTTs7dURBQUMsQUFBUyxLQUFHLEFBQUMsQUFDckI7Ozs7NEJBbElHLEFBQU8sQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBVyxZQUFDLEFBQU8sQUFBRSxBQUFzQyxBQUFDLEFBQUMsQUFDbEYsQUFBQyxBQUVELEFBQVk7Ozs7OztBQWlJZCxTQUFTLEFBQU8sUUFBQyxBQUFZLE1BQUUsQUFBb0IsU0FDakQ7V0FBTyxBQUFPLFdBQUksQUFBTyxRQUFDLEFBQUcsSUFBQyxBQUFJLEFBQUMsQUFBQyxBQUN0QyxBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcGlsZXJPcHMsIFByb2Nlc3NvciwgT3AsIE9wTmFtZSwgVGVtcGxhdGVDb21waWxlck9wcywgUGF0aEhlYWQgfSBmcm9tICcuL2NvbXBpbGVyLW9wcyc7XG5pbXBvcnQgeyBBU1QgfSBmcm9tICdAZ2xpbW1lci9zeW50YXgnO1xuaW1wb3J0IHsgT3B0aW9uLCBPcGFxdWUgfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFN0YWNrLCBleHBlY3QgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IFN5bWJvbFRhYmxlIH0gZnJvbSAnLi90ZW1wbGF0ZS12aXNpdG9yJztcblxuZXhwb3J0IHR5cGUgSW5WYXJpYWJsZSA9IFBhdGhIZWFkO1xuZXhwb3J0IHR5cGUgT3V0VmFyaWFibGUgPSBudW1iZXI7XG5cbmV4cG9ydCB0eXBlIE91dE9wPEsgZXh0ZW5kcyBrZXlvZiBDb21waWxlck9wczxPdXRWYXJpYWJsZT4gPSBPcE5hbWU+ID0gT3A8XG4gIE91dFZhcmlhYmxlLFxuICBDb21waWxlck9wczxPdXRWYXJpYWJsZT4sXG4gIEtcbj47XG5leHBvcnQgdHlwZSBJbk9wPEsgZXh0ZW5kcyBrZXlvZiBUZW1wbGF0ZUNvbXBpbGVyT3BzID0ga2V5b2YgVGVtcGxhdGVDb21waWxlck9wcz4gPSBPcDxcbiAgUGF0aEhlYWQsXG4gIFRlbXBsYXRlQ29tcGlsZXJPcHMsXG4gIEtcbj47XG5cbmV4cG9ydCBjbGFzcyBTeW1ib2xBbGxvY2F0b3JcbiAgaW1wbGVtZW50cyBQcm9jZXNzb3I8Q29tcGlsZXJPcHM8SW5WYXJpYWJsZT4sIE91dFZhcmlhYmxlLCBDb21waWxlck9wczxPdXRWYXJpYWJsZT4+IHtcbiAgcHJpdmF0ZSBzeW1ib2xTdGFjayA9IG5ldyBTdGFjazxTeW1ib2xUYWJsZT4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9wczogQXJyYXk8SW5PcD4pIHt9XG5cbiAgcHJvY2VzcygpOiBPdXRPcFtdIHtcbiAgICBsZXQgb3V0OiBPdXRPcFtdID0gW107XG4gICAgbGV0IHsgb3BzIH0gPSB0aGlzO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBvcCA9IG9wc1tpXTtcbiAgICAgIGxldCByZXN1bHQgPSB0aGlzLmRpc3BhdGNoKG9wKTtcblxuICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG91dC5wdXNoKG9wIGFzIE91dE9wKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dC5wdXNoKHJlc3VsdCBhcyBhbnkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICBkaXNwYXRjaDxPIGV4dGVuZHMgSW5PcD4ob3A6IE8pOiBPcGFxdWUge1xuICAgIGxldCBuYW1lID0gb3BbMF07XG4gICAgbGV0IG9wZXJhbmQgPSBvcFsxXTtcblxuICAgIHJldHVybiAodGhpc1tuYW1lXSBhcyBhbnkpKG9wZXJhbmQpO1xuICB9XG5cbiAgZ2V0IHN5bWJvbHMoKTogU3ltYm9sVGFibGUge1xuICAgIHJldHVybiBleHBlY3QodGhpcy5zeW1ib2xTdGFjay5jdXJyZW50LCAnRXhwZWN0ZWQgYSBzeW1ib2wgdGFibGUgb24gdGhlIHN0YWNrJyk7XG4gIH1cblxuICBzdGFydFByb2dyYW0ob3A6IEFTVC5Qcm9ncmFtKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wdXNoKG9wWydzeW1ib2xzJ10pO1xuICB9XG5cbiAgZW5kUHJvZ3JhbShfb3A6IG51bGwpIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnBvcCgpO1xuICB9XG5cbiAgc3RhcnRCbG9jayhvcDogQVNULlByb2dyYW0pIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnB1c2gob3BbJ3N5bWJvbHMnXSk7XG4gIH1cblxuICBlbmRCbG9jayhfb3A6IG51bGwpIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnBvcCgpO1xuICB9XG5cbiAgZmx1c2hFbGVtZW50KG9wOiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnB1c2gob3BbJ3N5bWJvbHMnXSk7XG4gIH1cblxuICBjbG9zZUVsZW1lbnQoX29wOiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnBvcCgpO1xuICB9XG5cbiAgY2xvc2VDb21wb25lbnQoX29wOiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnBvcCgpO1xuICB9XG5cbiAgY2xvc2VEeW5hbWljQ29tcG9uZW50KF9vcDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIGF0dHJTcGxhdChfb3A6IE9wdGlvbjxJblZhcmlhYmxlPik6IE91dE9wPCdhdHRyU3BsYXQnPiB7XG4gICAgcmV0dXJuIFsnYXR0clNwbGF0JywgdGhpcy5zeW1ib2xzLmFsbG9jYXRlQmxvY2soJ2F0dHJzJyldO1xuICB9XG5cbiAgZ2V0KG9wOiBbSW5WYXJpYWJsZSwgc3RyaW5nW11dKTogT3V0T3A8J2dldCcgfCAnbWF5YmVMb2NhbCc+IHtcbiAgICBsZXQgW25hbWUsIHJlc3RdID0gb3A7XG5cbiAgICBpZiAobmFtZSA9PT0gMCkge1xuICAgICAgcmV0dXJuIFsnZ2V0JywgWzAsIHJlc3RdXTtcbiAgICB9XG5cbiAgICBpZiAoaXNMb2NhbChuYW1lLCB0aGlzLnN5bWJvbHMpKSB7XG4gICAgICBsZXQgaGVhZCA9IHRoaXMuc3ltYm9scy5nZXQobmFtZSk7XG4gICAgICByZXR1cm4gWydnZXQnLCBbaGVhZCwgcmVzdF1dO1xuICAgIH0gZWxzZSBpZiAobmFtZVswXSA9PT0gJ0AnKSB7XG4gICAgICBsZXQgaGVhZCA9IHRoaXMuc3ltYm9scy5hbGxvY2F0ZU5hbWVkKG5hbWUpO1xuICAgICAgcmV0dXJuIFsnZ2V0JywgW2hlYWQsIHJlc3RdXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFsnbWF5YmVMb2NhbCcsIFtuYW1lLCAuLi5yZXN0XV07XG4gICAgfVxuICB9XG5cbiAgbWF5YmVHZXQob3A6IFtJblZhcmlhYmxlLCBzdHJpbmdbXV0pOiBPdXRPcDwnZ2V0JyB8ICd1bmtub3duJyB8ICdtYXliZUxvY2FsJz4ge1xuICAgIGxldCBbbmFtZSwgcmVzdF0gPSBvcDtcblxuICAgIGlmIChuYW1lID09PSAwKSB7XG4gICAgICByZXR1cm4gWydnZXQnLCBbMCwgcmVzdF1dO1xuICAgIH1cblxuICAgIGlmIChpc0xvY2FsKG5hbWUsIHRoaXMuc3ltYm9scykpIHtcbiAgICAgIGxldCBoZWFkID0gdGhpcy5zeW1ib2xzLmdldChuYW1lKTtcbiAgICAgIHJldHVybiBbJ2dldCcsIFtoZWFkLCByZXN0XV07XG4gICAgfSBlbHNlIGlmIChuYW1lWzBdID09PSAnQCcpIHtcbiAgICAgIGxldCBoZWFkID0gdGhpcy5zeW1ib2xzLmFsbG9jYXRlTmFtZWQobmFtZSk7XG4gICAgICByZXR1cm4gWydnZXQnLCBbaGVhZCwgcmVzdF1dO1xuICAgIH0gZWxzZSBpZiAocmVzdC5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBbJ3Vua25vd24nLCBuYW1lXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFsnbWF5YmVMb2NhbCcsIFtuYW1lLCAuLi5yZXN0XV07XG4gICAgfVxuICB9XG5cbiAgeWllbGQob3A6IEluVmFyaWFibGUpOiBPdXRPcDwneWllbGQnPiB7XG4gICAgaWYgKG9wID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCB5aWVsZCB0byB0aGlzJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFsneWllbGQnLCB0aGlzLnN5bWJvbHMuYWxsb2NhdGVCbG9jayhvcCldO1xuICB9XG5cbiAgZGVidWdnZXIoX29wOiBPcHRpb248SW5WYXJpYWJsZVtdPik6IE91dE9wPCdkZWJ1Z2dlcic+IHtcbiAgICByZXR1cm4gWydkZWJ1Z2dlcicsIHRoaXMuc3ltYm9scy5nZXRFdmFsSW5mbygpXTtcbiAgfVxuXG4gIGhhc0Jsb2NrKG9wOiBJblZhcmlhYmxlKTogT3V0T3A8J2hhc0Jsb2NrJz4ge1xuICAgIGlmIChvcCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgaGFzQmxvY2sgdGhpcycpO1xuICAgIH1cblxuICAgIHJldHVybiBbJ2hhc0Jsb2NrJywgdGhpcy5zeW1ib2xzLmFsbG9jYXRlQmxvY2sob3ApXTtcbiAgfVxuXG4gIGhhc0Jsb2NrUGFyYW1zKG9wOiBJblZhcmlhYmxlKTogT3V0T3A8J2hhc0Jsb2NrUGFyYW1zJz4ge1xuICAgIGlmIChvcCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgaGFzQmxvY2tQYXJhbXMgdGhpcycpO1xuICAgIH1cblxuICAgIHJldHVybiBbJ2hhc0Jsb2NrUGFyYW1zJywgdGhpcy5zeW1ib2xzLmFsbG9jYXRlQmxvY2sob3ApXTtcbiAgfVxuXG4gIHBhcnRpYWwoX29wOiBPcHRpb248SW5WYXJpYWJsZVtdPik6IE91dE9wPCdwYXJ0aWFsJz4ge1xuICAgIHJldHVybiBbJ3BhcnRpYWwnLCB0aGlzLnN5bWJvbHMuZ2V0RXZhbEluZm8oKV07XG4gIH1cblxuICB0ZXh0KF9vcDogc3RyaW5nKSB7fVxuICBjb21tZW50KF9vcDogc3RyaW5nKSB7fVxuICBvcGVuQ29tcG9uZW50KF9vcDogQVNULkVsZW1lbnROb2RlKSB7fVxuICBvcGVuRWxlbWVudChfb3A6IFtBU1QuRWxlbWVudE5vZGUsIGJvb2xlYW5dKSB7fVxuICBzdGF0aWNBcmcoX29wOiBzdHJpbmcpIHt9XG4gIGR5bmFtaWNBcmcoX29wOiBzdHJpbmcpIHt9XG4gIHN0YXRpY0F0dHIoX29wOiBbc3RyaW5nLCBPcHRpb248c3RyaW5nPl0pIHt9XG4gIHRydXN0aW5nQXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgdHJ1c3RpbmdDb21wb25lbnRBdHRyKF9vcDogW3N0cmluZywgT3B0aW9uPHN0cmluZz5dKSB7fVxuICBkeW5hbWljQXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgY29tcG9uZW50QXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgbW9kaWZpZXIoX29wOiBzdHJpbmcpIHt9XG4gIGFwcGVuZChfb3A6IGJvb2xlYW4pIHt9XG4gIGJsb2NrKF9vcDogW3N0cmluZywgbnVtYmVyLCBPcHRpb248bnVtYmVyPl0pIHt9XG4gIGxpdGVyYWwoX29wOiBzdHJpbmcgfCBib29sZWFuIHwgbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkge31cbiAgaGVscGVyKF9vcDogc3RyaW5nKSB7fVxuICB1bmtub3duKF9vcDogc3RyaW5nKSB7fVxuICBtYXliZUxvY2FsKF9vcDogc3RyaW5nW10pIHt9XG4gIHByZXBhcmVBcnJheShfb3A6IG51bWJlcikge31cbiAgcHJlcGFyZU9iamVjdChfb3A6IG51bWJlcikge31cbiAgY29uY2F0KF9vcDogbnVsbCkge31cbn1cblxuZnVuY3Rpb24gaXNMb2NhbChuYW1lOiBzdHJpbmcsIHN5bWJvbHM6IFN5bWJvbFRhYmxlKTogYm9vbGVhbiB7XG4gIHJldHVybiBzeW1ib2xzICYmIHN5bWJvbHMuaGFzKG5hbWUpO1xufVxuIl19