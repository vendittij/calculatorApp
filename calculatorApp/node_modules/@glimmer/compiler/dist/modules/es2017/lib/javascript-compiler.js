import { assert } from '@glimmer/util';
import { Stack, DictSet } from '@glimmer/util';
import { Ops, isFlushElement, isArgument, isAttribute } from '@glimmer/wire-format';
export class Block {
    constructor() {
        this.statements = [];
    }
    push(statement) {
        this.statements.push(statement);
    }
}
export class InlineBlock extends Block {
    constructor(table) {
        super();
        this.table = table;
    }
    toJSON() {
        return {
            statements: this.statements,
            parameters: this.table.slots
        };
    }
}
export class TemplateBlock extends Block {
    constructor(symbolTable) {
        super();
        this.symbolTable = symbolTable;
        this.type = 'template';
        this.yields = new DictSet();
        this.named = new DictSet();
        this.blocks = [];
        this.hasEval = false;
    }
    push(statement) {
        this.statements.push(statement);
    }
    toJSON() {
        return {
            symbols: this.symbolTable.symbols,
            statements: this.statements,
            hasEval: this.hasEval
        };
    }
}
export class ComponentBlock extends Block {
    constructor(tag, table, selfClosing) {
        super();
        this.tag = tag;
        this.table = table;
        this.selfClosing = selfClosing;
        this.attributes = [];
        this.arguments = [];
        this.inParams = true;
        this.positionals = [];
    }
    push(statement) {
        if (this.inParams) {
            if (isFlushElement(statement)) {
                this.inParams = false;
            } else if (isArgument(statement)) {
                this.arguments.push(statement);
            } else if (isAttribute(statement)) {
                this.attributes.push(statement);
            } else {
                throw new Error('Compile Error: only parameters allowed before flush-element');
            }
        } else {
            this.statements.push(statement);
        }
    }
    toJSON() {
        let args = this.arguments;
        let keys = args.map(arg => arg[1]);
        let values = args.map(arg => arg[2]);
        let block = this.selfClosing ? null : {
            statements: this.statements,
            parameters: this.table.slots
        };
        return [this.tag, this.attributes, [keys, values], block];
    }
}
export class Template {
    constructor(symbols) {
        this.block = new TemplateBlock(symbols);
    }
    toJSON() {
        return this.block.toJSON();
    }
}
export default class JavaScriptCompiler {
    constructor(opcodes, symbols, options) {
        this.blocks = new Stack();
        this.values = [];
        this.opcodes = opcodes;
        this.template = new Template(symbols);
        this.options = options;
    }
    static process(opcodes, symbols, options) {
        let compiler = new JavaScriptCompiler(opcodes, symbols, options);
        return compiler.process();
    }
    get currentBlock() {
        return this.blocks.current;
    }
    process() {
        this.opcodes.forEach(op => {
            let opcode = op[0];
            let arg = op[1];
            if (!this[opcode]) {
                throw new Error(`unimplemented ${opcode} on JavaScriptCompiler`);
            }
            this[opcode](arg);
        });
        return this.template;
    }
    /// Nesting
    startBlock(program) {
        let block = new InlineBlock(program['symbols']);
        this.blocks.push(block);
    }
    endBlock() {
        let { template, blocks } = this;
        let block = blocks.pop();
        template.block.blocks.push(block.toJSON());
    }
    startProgram() {
        this.blocks.push(this.template.block);
    }
    endProgram() {}
    /// Statements
    text(content) {
        this.push([Ops.Text, content]);
    }
    append(trusted) {
        this.push([Ops.Append, this.popValue(), trusted]);
    }
    comment(value) {
        this.push([Ops.Comment, value]);
    }
    modifier(name) {
        let params = this.popValue();
        let hash = this.popValue();
        this.push([Ops.Modifier, name, params, hash]);
    }
    block([name, template, inverse]) {
        let params = this.popValue();
        let hash = this.popValue();
        let blocks = this.template.block.blocks;
        (false && assert(typeof template !== 'number' || blocks[template] !== null, 'missing block in the compiler'));
        (false && assert(typeof inverse !== 'number' || blocks[inverse] !== null, 'missing block in the compiler'));

        this.push([Ops.Block, name, params, hash, blocks[template], blocks[inverse]]);
    }
    openComponent(element) {
        let tag = this.options && this.options.customizeComponentName ? this.options.customizeComponentName(element.tag) : element.tag;
        let component = new ComponentBlock(tag, element['symbols'], element.selfClosing);
        this.blocks.push(component);
    }
    openElement([element, simple]) {
        let tag = element.tag;
        if (element.blockParams.length > 0) {
            throw new Error(`Compile Error: <${element.tag}> is not a component and doesn't support block parameters`);
        } else {
            this.push([Ops.OpenElement, tag, simple]);
        }
    }
    flushElement() {
        this.push([Ops.FlushElement]);
    }
    closeComponent(_element) {
        let [tag, attrs, args, block] = this.endComponent();
        this.push([Ops.Component, tag, attrs, args, block]);
    }
    closeDynamicComponent(_element) {
        let [, attrs, args, block] = this.endComponent();
        this.push([Ops.DynamicComponent, this.popValue(), attrs, args, block]);
    }
    closeElement(_element) {
        this.push([Ops.CloseElement]);
    }
    staticAttr([name, namespace]) {
        let value = this.popValue();
        this.push([Ops.StaticAttr, name, value, namespace]);
    }
    dynamicAttr([name, namespace]) {
        let value = this.popValue();
        this.push([Ops.DynamicAttr, name, value, namespace]);
    }
    componentAttr([name, namespace]) {
        let value = this.popValue();
        this.push([Ops.ComponentAttr, name, value, namespace]);
    }
    trustingAttr([name, namespace]) {
        let value = this.popValue();
        this.push([Ops.TrustingAttr, name, value, namespace]);
    }
    trustingComponentAttr([name, namespace]) {
        let value = this.popValue();
        this.push([Ops.TrustingComponentAttr, name, value, namespace]);
    }
    staticArg(name) {
        let value = this.popValue();
        this.push([Ops.StaticArg, name, value]);
    }
    dynamicArg(name) {
        let value = this.popValue();
        this.push([Ops.DynamicArg, name, value]);
    }
    yield(to) {
        let params = this.popValue();
        this.push([Ops.Yield, to, params]);
    }
    attrSplat(to) {
        // consume (and disregard) the value pushed for the
        // ...attributes attribute
        this.popValue();
        this.push([Ops.AttrSplat, to]);
    }
    debugger(evalInfo) {
        this.push([Ops.Debugger, evalInfo]);
        this.template.block.hasEval = true;
    }
    hasBlock(name) {
        this.pushValue([Ops.HasBlock, name]);
    }
    hasBlockParams(name) {
        this.pushValue([Ops.HasBlockParams, name]);
    }
    partial(evalInfo) {
        let params = this.popValue();
        this.push([Ops.Partial, params[0], evalInfo]);
        this.template.block.hasEval = true;
    }
    /// Expressions
    literal(value) {
        if (value === undefined) {
            this.pushValue([Ops.Undefined]);
        } else {
            this.pushValue(value);
        }
    }
    unknown(name) {
        this.pushValue([Ops.Unknown, name]);
    }
    get([head, path]) {
        this.pushValue([Ops.Get, head, path]);
    }
    maybeLocal(path) {
        this.pushValue([Ops.MaybeLocal, path]);
    }
    concat() {
        this.pushValue([Ops.Concat, this.popValue()]);
    }
    helper(name) {
        let params = this.popValue();
        let hash = this.popValue();
        this.pushValue([Ops.Helper, name, params, hash]);
    }
    /// Stack Management Opcodes
    prepareArray(size) {
        let values = [];
        for (let i = 0; i < size; i++) {
            values.push(this.popValue());
        }
        this.pushValue(values);
    }
    prepareObject(size) {
        (false && assert(this.values.length >= size, `Expected ${size} values on the stack, found ${this.values.length}`));

        let keys = new Array(size);
        let values = new Array(size);
        for (let i = 0; i < size; i++) {
            keys[i] = this.popValue();
            values[i] = this.popValue();
        }
        this.pushValue([keys, values]);
    }
    /// Utilities
    endComponent() {
        let component = this.blocks.pop();
        (false && assert(component instanceof ComponentBlock, 'Compiler bug: endComponent() should end a component'));

        return component.toJSON();
    }
    push(args) {
        while (args[args.length - 1] === null) {
            args.pop();
        }
        this.currentBlock.push(args);
    }
    pushValue(val) {
        this.values.push(val);
    }
    popValue() {
        (false && assert(this.values.length, 'No expression found on stack'));

        return this.values.pop();
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiamF2YXNjcmlwdC1jb21waWxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9qYXZhc2NyaXB0LWNvbXBpbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLEFBQU8sU0FBRSxBQUFNLEFBQUUsY0FBTSxBQUFlLEFBQUM7QUFDdkMsQUFBTyxTQUFFLEFBQUssT0FBRSxBQUFPLEFBQVUsQUFBTSxBQUFFLGVBQU0sQUFBZSxBQUFDO0FBSS9ELEFBQU8sU0FRTCxBQUFHLEtBQ0gsQUFBYyxnQkFDZCxBQUFVLFlBQ1YsQUFBVyxBQUNaLG1CQUFNLEFBQXNCLEFBQUM7QUFTOUIsQUFBTSxhQUFnQixBQUFLO0FBQTNCO0FBQ1MsYUFBVSxhQUFnQixBQUFFLEFBQUMsQUFPdEM7QUFBQztBQUhDLEFBQUksU0FBQyxBQUFvQjtBQUN2QixBQUFJLGFBQUMsQUFBVSxXQUFDLEFBQUksS0FBQyxBQUFTLEFBQUMsQUFBQyxBQUNsQztBQUFDLEFBQ0Y7O0FBRUQsQUFBTSxhQUFPLEFBQVksb0JBQVEsQUFBSztBQUNwQyxnQkFBbUIsQUFBdUI7QUFDeEMsQUFBSyxBQUFFLEFBQUM7QUFEUyxhQUFLLFFBQUwsQUFBSyxBQUFrQixBQUUxQztBQUFDO0FBRUQsQUFBTTtBQUNKO0FBQ0UsQUFBVSx3QkFBRSxBQUFJLEtBQUMsQUFBVTtBQUMzQixBQUFVLHdCQUFFLEFBQUksS0FBQyxBQUFLLE1BQUMsQUFBSyxBQUM3QixBQUFDLEFBQ0o7QUFKUztBQUlSLEFBQ0Y7O0FBRUQsQUFBTSxhQUFPLEFBQWMsc0JBQVEsQUFBSztBQU90QyxnQkFBb0IsQUFBK0I7QUFDakQsQUFBSyxBQUFFLEFBQUM7QUFEVSxhQUFXLGNBQVgsQUFBVyxBQUFvQjtBQU41QyxhQUFJLE9BQUcsQUFBVSxBQUFDO0FBQ2xCLGFBQU0sU0FBRyxJQUFJLEFBQU8sQUFBVSxBQUFDO0FBQy9CLGFBQUssUUFBRyxJQUFJ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bSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBTdGFjaywgRGljdFNldCwgT3B0aW9uLCBleHBlY3QgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IEFTVCB9IGZyb20gJ0BnbGltbWVyL3N5bnRheCc7XG5pbXBvcnQgeyBCbG9ja1N5bWJvbFRhYmxlLCBQcm9ncmFtU3ltYm9sVGFibGUgfSBmcm9tICcuL3RlbXBsYXRlLXZpc2l0b3InO1xuaW1wb3J0IHsgQ29tcGlsZU9wdGlvbnMgfSBmcm9tICcuL3RlbXBsYXRlLWNvbXBpbGVyJztcbmltcG9ydCB7XG4gIFNlcmlhbGl6ZWRJbmxpbmVCbG9jayxcbiAgU2VyaWFsaXplZFRlbXBsYXRlQmxvY2ssXG4gIENvcmUsXG4gIFN0YXRlbWVudCxcbiAgU3RhdGVtZW50cyxcbiAgRXhwcmVzc2lvbixcbiAgRXhwcmVzc2lvbnMsXG4gIE9wcyxcbiAgaXNGbHVzaEVsZW1lbnQsXG4gIGlzQXJndW1lbnQsXG4gIGlzQXR0cmlidXRlLFxufSBmcm9tICdAZ2xpbW1lci93aXJlLWZvcm1hdCc7XG5pbXBvcnQgeyBQcm9jZXNzb3IsIENvbXBpbGVyT3BzLCBPcE5hbWUsIE9wIH0gZnJvbSAnLi9jb21waWxlci1vcHMnO1xuXG5leHBvcnQgdHlwZSBzdHIgPSBzdHJpbmc7XG5leHBvcnQgdHlwZSBQYXJhbXMgPSBDb3JlLlBhcmFtcztcbmV4cG9ydCB0eXBlIEhhc2ggPSBDb3JlLkhhc2g7XG5leHBvcnQgdHlwZSBQYXRoID0gQ29yZS5QYXRoO1xuZXhwb3J0IHR5cGUgU3RhY2tWYWx1ZSA9IEV4cHJlc3Npb24gfCBQYXJhbXMgfCBIYXNoIHwgc3RyO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQmxvY2sge1xuICBwdWJsaWMgc3RhdGVtZW50czogU3RhdGVtZW50W10gPSBbXTtcblxuICBhYnN0cmFjdCB0b0pTT04oKTogT2JqZWN0O1xuXG4gIHB1c2goc3RhdGVtZW50OiBTdGF0ZW1lbnQpIHtcbiAgICB0aGlzLnN0YXRlbWVudHMucHVzaChzdGF0ZW1lbnQpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBJbmxpbmVCbG9jayBleHRlbmRzIEJsb2NrIHtcbiAgY29uc3RydWN0b3IocHVibGljIHRhYmxlOiBCbG9ja1N5bWJvbFRhYmxlKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIHRvSlNPTigpOiBTZXJpYWxpemVkSW5saW5lQmxvY2sge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0ZW1lbnRzOiB0aGlzLnN0YXRlbWVudHMsXG4gICAgICBwYXJhbWV0ZXJzOiB0aGlzLnRhYmxlLnNsb3RzLFxuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFRlbXBsYXRlQmxvY2sgZXh0ZW5kcyBCbG9jayB7XG4gIHB1YmxpYyB0eXBlID0gJ3RlbXBsYXRlJztcbiAgcHVibGljIHlpZWxkcyA9IG5ldyBEaWN0U2V0PHN0cmluZz4oKTtcbiAgcHVibGljIG5hbWVkID0gbmV3IERpY3RTZXQ8c3RyaW5nPigpO1xuICBwdWJsaWMgYmxvY2tzOiBTZXJpYWxpemVkSW5saW5lQmxvY2tbXSA9IFtdO1xuICBwdWJsaWMgaGFzRXZhbCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgc3ltYm9sVGFibGU6IFByb2dyYW1TeW1ib2xUYWJsZSkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBwdXNoKHN0YXRlbWVudDogU3RhdGVtZW50KSB7XG4gICAgdGhpcy5zdGF0ZW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgfVxuXG4gIHRvSlNPTigpOiBTZXJpYWxpemVkVGVtcGxhdGVCbG9jayB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN5bWJvbHM6IHRoaXMuc3ltYm9sVGFibGUuc3ltYm9scyxcbiAgICAgIHN0YXRlbWVudHM6IHRoaXMuc3RhdGVtZW50cyxcbiAgICAgIGhhc0V2YWw6IHRoaXMuaGFzRXZhbCxcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDb21wb25lbnRCbG9jayBleHRlbmRzIEJsb2NrIHtcbiAgcHVibGljIGF0dHJpYnV0ZXM6IFN0YXRlbWVudHMuQXR0cmlidXRlW10gPSBbXTtcbiAgcHVibGljIGFyZ3VtZW50czogU3RhdGVtZW50cy5Bcmd1bWVudFtdID0gW107XG4gIHByaXZhdGUgaW5QYXJhbXMgPSB0cnVlO1xuICBwdWJsaWMgcG9zaXRpb25hbHM6IG51bWJlcltdID0gW107XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSB0YWc6IHN0cmluZywgcHJpdmF0ZSB0YWJsZTogQmxvY2tTeW1ib2xUYWJsZSwgcHJpdmF0ZSBzZWxmQ2xvc2luZzogYm9vbGVhbikge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBwdXNoKHN0YXRlbWVudDogU3RhdGVtZW50KSB7XG4gICAgaWYgKHRoaXMuaW5QYXJhbXMpIHtcbiAgICAgIGlmIChpc0ZsdXNoRWxlbWVudChzdGF0ZW1lbnQpKSB7XG4gICAgICAgIHRoaXMuaW5QYXJhbXMgPSBmYWxzZTtcbiAgICAgIH0gZWxzZSBpZiAoaXNBcmd1bWVudChzdGF0ZW1lbnQpKSB7XG4gICAgICAgIHRoaXMuYXJndW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgICAgIH0gZWxzZSBpZiAoaXNBdHRyaWJ1dGUoc3RhdGVtZW50KSkge1xuICAgICAgICB0aGlzLmF0dHJpYnV0ZXMucHVzaChzdGF0ZW1lbnQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21waWxlIEVycm9yOiBvbmx5IHBhcmFtZXRlcnMgYWxsb3dlZCBiZWZvcmUgZmx1c2gtZWxlbWVudCcpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0YXRlbWVudHMucHVzaChzdGF0ZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIHRvSlNPTigpOiBbc3RyaW5nLCBTdGF0ZW1lbnRzLkF0dHJpYnV0ZVtdLCBDb3JlLkhhc2gsIE9wdGlvbjxTZXJpYWxpemVkSW5saW5lQmxvY2s+XSB7XG4gICAgbGV0IGFyZ3MgPSB0aGlzLmFyZ3VtZW50cztcbiAgICBsZXQga2V5cyA9IGFyZ3MubWFwKGFyZyA9PiBhcmdbMV0pO1xuICAgIGxldCB2YWx1ZXMgPSBhcmdzLm1hcChhcmcgPT4gYXJnWzJdKTtcbiAgICBsZXQgYmxvY2sgPSB0aGlzLnNlbGZDbG9zaW5nXG4gICAgICA/IG51bGxcbiAgICAgIDoge1xuICAgICAgICAgIHN0YXRlbWVudHM6IHRoaXMuc3RhdGVtZW50cyxcbiAgICAgICAgICBwYXJhbWV0ZXJzOiB0aGlzLnRhYmxlLnNsb3RzLFxuICAgICAgICB9O1xuXG4gICAgcmV0dXJuIFt0aGlzLnRhZywgdGhpcy5hdHRyaWJ1dGVzLCBba2V5cywgdmFsdWVzXSwgYmxvY2tdO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZSB7XG4gIHB1YmxpYyBibG9jazogVGVtcGxhdGVCbG9jaztcblxuICBjb25zdHJ1Y3RvcihzeW1ib2xzOiBQcm9ncmFtU3ltYm9sVGFibGUpIHtcbiAgICB0aGlzLmJsb2NrID0gbmV3IFRlbXBsYXRlQmxvY2soc3ltYm9scyk7XG4gIH1cblxuICB0b0pTT04oKTogU2VyaWFsaXplZFRlbXBsYXRlQmxvY2sge1xuICAgIHJldHVybiB0aGlzLmJsb2NrLnRvSlNPTigpO1xuICB9XG59XG5cbmV4cG9ydCB0eXBlIEluVmFyaWFibGUgPSBudW1iZXI7XG5leHBvcnQgdHlwZSBJbk9wPEsgZXh0ZW5kcyBrZXlvZiBDb21waWxlck9wczxJblZhcmlhYmxlPiA9IE9wTmFtZT4gPSBPcDxcbiAgSW5WYXJpYWJsZSxcbiAgQ29tcGlsZXJPcHM8SW5WYXJpYWJsZT4sXG4gIEtcbj47XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEphdmFTY3JpcHRDb21waWxlclxuICBpbXBsZW1lbnRzIFByb2Nlc3NvcjxDb21waWxlck9wczxudW1iZXI+LCB2b2lkLCBDb21waWxlck9wczx2b2lkPj4ge1xuICBzdGF0aWMgcHJvY2VzcyhvcGNvZGVzOiBJbk9wW10sIHN5bWJvbHM6IFByb2dyYW1TeW1ib2xUYWJsZSwgb3B0aW9ucz86IENvbXBpbGVPcHRpb25zKTogVGVtcGxhdGUge1xuICAgIGxldCBjb21waWxlciA9IG5ldyBKYXZhU2NyaXB0Q29tcGlsZXIob3Bjb2Rlcywgc3ltYm9scywgb3B0aW9ucyk7XG4gICAgcmV0dXJuIGNvbXBpbGVyLnByb2Nlc3MoKTtcbiAgfVxuXG4gIHByaXZhdGUgdGVtcGxhdGU6IFRlbXBsYXRlO1xuICBwcml2YXRlIGJsb2NrcyA9IG5ldyBTdGFjazxCbG9jaz4oKTtcbiAgcHJpdmF0ZSBvcGNvZGVzOiBJbk9wW107XG4gIHByaXZhdGUgdmFsdWVzOiBTdGFja1ZhbHVlW10gPSBbXTtcbiAgcHJpdmF0ZSBvcHRpb25zOiBDb21waWxlT3B0aW9ucyB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3RvcihvcGNvZGVzOiBJbk9wW10sIHN5bWJvbHM6IFByb2dyYW1TeW1ib2xUYWJsZSwgb3B0aW9ucz86IENvbXBpbGVPcHRpb25zKSB7XG4gICAgdGhpcy5vcGNvZGVzID0gb3Bjb2RlcztcbiAgICB0aGlzLnRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHN5bWJvbHMpO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gIH1cblxuICBnZXQgY3VycmVudEJsb2NrKCk6IEJsb2NrIHtcbiAgICByZXR1cm4gZXhwZWN0KHRoaXMuYmxvY2tzLmN1cnJlbnQsICdFeHBlY3RlZCBhIGJsb2NrIG9uIHRoZSBzdGFjaycpO1xuICB9XG5cbiAgcHJvY2VzcygpOiBUZW1wbGF0ZSB7XG4gICAgdGhpcy5vcGNvZGVzLmZvckVhY2gob3AgPT4ge1xuICAgICAgbGV0IG9wY29kZSA9IG9wWzBdO1xuICAgICAgbGV0IGFyZyA9IG9wWzFdO1xuXG4gICAgICBpZiAoIXRoaXNbb3Bjb2RlXSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVuaW1wbGVtZW50ZWQgJHtvcGNvZGV9IG9uIEphdmFTY3JpcHRDb21waWxlcmApO1xuICAgICAgfVxuICAgICAgKHRoaXNbb3Bjb2RlXSBhcyBhbnkpKGFyZyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMudGVtcGxhdGU7XG4gIH1cblxuICAvLy8gTmVzdGluZ1xuXG4gIHN0YXJ0QmxvY2socHJvZ3JhbTogQVNULlByb2dyYW0pIHtcbiAgICBsZXQgYmxvY2s6IEJsb2NrID0gbmV3IElubGluZUJsb2NrKHByb2dyYW1bJ3N5bWJvbHMnXSk7XG4gICAgdGhpcy5ibG9ja3MucHVzaChibG9jayk7XG4gIH1cblxuICBlbmRCbG9jaygpIHtcbiAgICBsZXQgeyB0ZW1wbGF0ZSwgYmxvY2tzIH0gPSB0aGlzO1xuICAgIGxldCBibG9jayA9IGJsb2Nrcy5wb3AoKSBhcyBJbmxpbmVCbG9jaztcbiAgICB0ZW1wbGF0ZS5ibG9jay5ibG9ja3MucHVzaChibG9jay50b0pTT04oKSk7XG4gIH1cblxuICBzdGFydFByb2dyYW0oKSB7XG4gICAgdGhpcy5ibG9ja3MucHVzaCh0aGlzLnRlbXBsYXRlLmJsb2NrKTtcbiAgfVxuXG4gIGVuZFByb2dyYW0oKSB7fVxuXG4gIC8vLyBTdGF0ZW1lbnRzXG5cbiAgdGV4dChjb250ZW50OiBzdHJpbmcpIHtcbiAgICB0aGlzLnB1c2goW09wcy5UZXh0LCBjb250ZW50XSk7XG4gIH1cblxuICBhcHBlbmQodHJ1c3RlZDogYm9vbGVhbikge1xuICAgIHRoaXMucHVzaChbT3BzLkFwcGVuZCwgdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpLCB0cnVzdGVkXSk7XG4gIH1cblxuICBjb21tZW50KHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLnB1c2goW09wcy5Db21tZW50LCB2YWx1ZV0pO1xuICB9XG5cbiAgbW9kaWZpZXIobmFtZTogc3RyaW5nKSB7XG4gICAgbGV0IHBhcmFtcyA9IHRoaXMucG9wVmFsdWU8UGFyYW1zPigpO1xuICAgIGxldCBoYXNoID0gdGhpcy5wb3BWYWx1ZTxIYXNoPigpO1xuXG4gICAgdGhpcy5wdXNoKFtPcHMuTW9kaWZpZXIsIG5hbWUsIHBhcmFtcywgaGFzaF0pO1xuICB9XG5cbiAgYmxvY2soW25hbWUsIHRlbXBsYXRlLCBpbnZlcnNlXTogW3N0cmluZywgbnVtYmVyLCBPcHRpb248bnVtYmVyPl0pIHtcbiAgICBsZXQgcGFyYW1zID0gdGhpcy5wb3BWYWx1ZTxQYXJhbXM+KCk7XG4gICAgbGV0IGhhc2ggPSB0aGlzLnBvcFZhbHVlPEhhc2g+KCk7XG5cbiAgICBsZXQgYmxvY2tzID0gdGhpcy50ZW1wbGF0ZS5ibG9jay5ibG9ja3M7XG4gICAgYXNzZXJ0KFxuICAgICAgdHlwZW9mIHRlbXBsYXRlICE9PSAnbnVtYmVyJyB8fCBibG9ja3NbdGVtcGxhdGVdICE9PSBudWxsLFxuICAgICAgJ21pc3NpbmcgYmxvY2sgaW4gdGhlIGNvbXBpbGVyJ1xuICAgICk7XG4gICAgYXNzZXJ0KFxuICAgICAgdHlwZW9mIGludmVyc2UgIT09ICdudW1iZXInIHx8IGJsb2Nrc1tpbnZlcnNlXSAhPT0gbnVsbCxcbiAgICAgICdtaXNzaW5nIGJsb2NrIGluIHRoZSBjb21waWxlcidcbiAgICApO1xuXG4gICAgdGhpcy5wdXNoKFtPcHMuQmxvY2ssIG5hbWUsIHBhcmFtcywgaGFzaCwgYmxvY2tzW3RlbXBsYXRlXSwgYmxvY2tzW2ludmVyc2UhXV0pO1xuICB9XG5cbiAgb3BlbkNvbXBvbmVudChlbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICBsZXQgdGFnID1cbiAgICAgIHRoaXMub3B0aW9ucyAmJiB0aGlzLm9wdGlvbnMuY3VzdG9taXplQ29tcG9uZW50TmFtZVxuICAgICAgICA/IHRoaXMub3B0aW9ucy5jdXN0b21pemVDb21wb25lbnROYW1lKGVsZW1lbnQudGFnKVxuICAgICAgICA6IGVsZW1lbnQudGFnO1xuICAgIGxldCBjb21wb25lbnQgPSBuZXcgQ29tcG9uZW50QmxvY2sodGFnLCBlbGVtZW50WydzeW1ib2xzJ10sIGVsZW1lbnQuc2VsZkNsb3NpbmcpO1xuICAgIHRoaXMuYmxvY2tzLnB1c2goY29tcG9uZW50KTtcbiAgfVxuXG4gIG9wZW5FbGVtZW50KFtlbGVtZW50LCBzaW1wbGVdOiBbQVNULkVsZW1lbnROb2RlLCBib29sZWFuXSkge1xuICAgIGxldCB0YWcgPSBlbGVtZW50LnRhZztcblxuICAgIGlmIChlbGVtZW50LmJsb2NrUGFyYW1zLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENvbXBpbGUgRXJyb3I6IDwke2VsZW1lbnQudGFnfT4gaXMgbm90IGEgY29tcG9uZW50IGFuZCBkb2Vzbid0IHN1cHBvcnQgYmxvY2sgcGFyYW1ldGVyc2BcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHVzaChbT3BzLk9wZW5FbGVtZW50LCB0YWcsIHNpbXBsZV0pO1xuICAgIH1cbiAgfVxuXG4gIGZsdXNoRWxlbWVudCgpIHtcbiAgICB0aGlzLnB1c2goW09wcy5GbHVzaEVsZW1lbnRdKTtcbiAgfVxuXG4gIGNsb3NlQ29tcG9uZW50KF9lbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICBsZXQgW3RhZywgYXR0cnMsIGFyZ3MsIGJsb2NrXSA9IHRoaXMuZW5kQ29tcG9uZW50KCk7XG5cbiAgICB0aGlzLnB1c2goW09wcy5Db21wb25lbnQsIHRhZywgYXR0cnMsIGFyZ3MsIGJsb2NrXSk7XG4gIH1cblxuICBjbG9zZUR5bmFtaWNDb21wb25lbnQoX2VsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIGxldCBbLCBhdHRycywgYXJncywgYmxvY2tdID0gdGhpcy5lbmRDb21wb25lbnQoKTtcblxuICAgIHRoaXMucHVzaChbT3BzLkR5bmFtaWNDb21wb25lbnQsIHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKSwgYXR0cnMsIGFyZ3MsIGJsb2NrXSk7XG4gIH1cblxuICBjbG9zZUVsZW1lbnQoX2VsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIHRoaXMucHVzaChbT3BzLkNsb3NlRWxlbWVudF0pO1xuICB9XG5cbiAgc3RhdGljQXR0cihbbmFtZSwgbmFtZXNwYWNlXTogW3N0cmluZywgT3B0aW9uPHN0cmluZz5dKSB7XG4gICAgbGV0IHZhbHVlID0gdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpO1xuICAgIHRoaXMucHVzaChbT3BzLlN0YXRpY0F0dHIsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2VdKTtcbiAgfVxuXG4gIGR5bmFtaWNBdHRyKFtuYW1lLCBuYW1lc3BhY2VdOiBbc3RyaW5nLCBPcHRpb248c3RyaW5nPl0pIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFtPcHMuRHluYW1pY0F0dHIsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2VdKTtcbiAgfVxuXG4gIGNvbXBvbmVudEF0dHIoW25hbWUsIG5hbWVzcGFjZV06IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goW09wcy5Db21wb25lbnRBdHRyLCBuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlXSk7XG4gIH1cblxuICB0cnVzdGluZ0F0dHIoW25hbWUsIG5hbWVzcGFjZV06IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goW09wcy5UcnVzdGluZ0F0dHIsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UhXSk7XG4gIH1cblxuICB0cnVzdGluZ0NvbXBvbmVudEF0dHIoW25hbWUsIG5hbWVzcGFjZV06IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goW09wcy5UcnVzdGluZ0NvbXBvbmVudEF0dHIsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UhXSk7XG4gIH1cblxuICBzdGF0aWNBcmcobmFtZTogc3RyKSB7XG4gICAgbGV0IHZhbHVlID0gdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpO1xuICAgIHRoaXMucHVzaChbT3BzLlN0YXRpY0FyZywgbmFtZSwgdmFsdWVdKTtcbiAgfVxuXG4gIGR5bmFtaWNBcmcobmFtZTogc3RyKSB7XG4gICAgbGV0IHZhbHVlID0gdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpO1xuICAgIHRoaXMucHVzaChbT3BzLkR5bmFtaWNBcmcsIG5hbWUsIHZhbHVlXSk7XG4gIH1cblxuICB5aWVsZCh0bzogbnVtYmVyKSB7XG4gICAgbGV0IHBhcmFtcyA9IHRoaXMucG9wVmFsdWU8UGFyYW1zPigpO1xuICAgIHRoaXMucHVzaChbT3BzLllpZWxkLCB0bywgcGFyYW1zXSk7XG4gIH1cblxuICBhdHRyU3BsYXQodG86IE9wdGlvbjxudW1iZXI+KSB7XG4gICAgLy8gY29uc3VtZSAoYW5kIGRpc3JlZ2FyZCkgdGhlIHZhbHVlIHB1c2hlZCBmb3IgdGhlXG4gICAgLy8gLi4uYXR0cmlidXRlcyBhdHRyaWJ1dGVcbiAgICB0aGlzLnBvcFZhbHVlKCk7XG4gICAgdGhpcy5wdXNoKFtPcHMuQXR0clNwbGF0LCB0byFdKTtcbiAgfVxuXG4gIGRlYnVnZ2VyKGV2YWxJbmZvOiBPcHRpb248Q29yZS5FdmFsSW5mbz4pIHtcbiAgICB0aGlzLnB1c2goW09wcy5EZWJ1Z2dlciwgZXZhbEluZm8hXSk7XG4gICAgdGhpcy50ZW1wbGF0ZS5ibG9jay5oYXNFdmFsID0gdHJ1ZTtcbiAgfVxuXG4gIGhhc0Jsb2NrKG5hbWU6IG51bWJlcikge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkhhc0Jsb2NrPihbT3BzLkhhc0Jsb2NrLCBuYW1lXSk7XG4gIH1cblxuICBoYXNCbG9ja1BhcmFtcyhuYW1lOiBudW1iZXIpIHtcbiAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5IYXNCbG9ja1BhcmFtcz4oW09wcy5IYXNCbG9ja1BhcmFtcywgbmFtZV0pO1xuICB9XG5cbiAgcGFydGlhbChldmFsSW5mbzogT3B0aW9uPENvcmUuRXZhbEluZm8+KSB7XG4gICAgbGV0IHBhcmFtcyA9IHRoaXMucG9wVmFsdWU8UGFyYW1zPigpO1xuICAgIHRoaXMucHVzaChbT3BzLlBhcnRpYWwsIHBhcmFtc1swXSwgZXZhbEluZm8hXSk7XG4gICAgdGhpcy50ZW1wbGF0ZS5ibG9jay5oYXNFdmFsID0gdHJ1ZTtcbiAgfVxuXG4gIC8vLyBFeHByZXNzaW9uc1xuXG4gIGxpdGVyYWwodmFsdWU6IEV4cHJlc3Npb25zLlZhbHVlIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLlVuZGVmaW5lZD4oW09wcy5VbmRlZmluZWRdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuVmFsdWU+KHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICB1bmtub3duKG5hbWU6IHN0cmluZykge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLlVua25vd24+KFtPcHMuVW5rbm93biwgbmFtZV0pO1xuICB9XG5cbiAgZ2V0KFtoZWFkLCBwYXRoXTogW251bWJlciwgc3RyaW5nW11dKSB7XG4gICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuR2V0PihbT3BzLkdldCwgaGVhZCwgcGF0aF0pO1xuICB9XG5cbiAgbWF5YmVMb2NhbChwYXRoOiBzdHJpbmdbXSkge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLk1heWJlTG9jYWw+KFtPcHMuTWF5YmVMb2NhbCwgcGF0aF0pO1xuICB9XG5cbiAgY29uY2F0KCkge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkNvbmNhdD4oW09wcy5Db25jYXQsIHRoaXMucG9wVmFsdWU8UGFyYW1zPigpXSk7XG4gIH1cblxuICBoZWxwZXIobmFtZTogc3RyaW5nKSB7XG4gICAgbGV0IHBhcmFtcyA9IHRoaXMucG9wVmFsdWU8UGFyYW1zPigpO1xuICAgIGxldCBoYXNoID0gdGhpcy5wb3BWYWx1ZTxIYXNoPigpO1xuXG4gICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuSGVscGVyPihbT3BzLkhlbHBlciwgbmFtZSwgcGFyYW1zLCBoYXNoXSk7XG4gIH1cblxuICAvLy8gU3RhY2sgTWFuYWdlbWVudCBPcGNvZGVzXG5cbiAgcHJlcGFyZUFycmF5KHNpemU6IG51bWJlcikge1xuICAgIGxldCB2YWx1ZXM6IEV4cHJlc3Npb25bXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHtcbiAgICAgIHZhbHVlcy5wdXNoKHRoaXMucG9wVmFsdWUoKSBhcyBFeHByZXNzaW9uKTtcbiAgICB9XG5cbiAgICB0aGlzLnB1c2hWYWx1ZTxQYXJhbXM+KHZhbHVlcyk7XG4gIH1cblxuICBwcmVwYXJlT2JqZWN0KHNpemU6IG51bWJlcikge1xuICAgIGFzc2VydChcbiAgICAgIHRoaXMudmFsdWVzLmxlbmd0aCA+PSBzaXplLFxuICAgICAgYEV4cGVjdGVkICR7c2l6ZX0gdmFsdWVzIG9uIHRoZSBzdGFjaywgZm91bmQgJHt0aGlzLnZhbHVlcy5sZW5ndGh9YFxuICAgICk7XG5cbiAgICBsZXQga2V5czogc3RyaW5nW10gPSBuZXcgQXJyYXkoc2l6ZSk7XG4gICAgbGV0IHZhbHVlczogRXhwcmVzc2lvbltdID0gbmV3IEFycmF5KHNpemUpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHtcbiAgICAgIGtleXNbaV0gPSB0aGlzLnBvcFZhbHVlPHN0cj4oKTtcbiAgICAgIHZhbHVlc1tpXSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB9XG5cbiAgICB0aGlzLnB1c2hWYWx1ZTxIYXNoPihba2V5cywgdmFsdWVzXSk7XG4gIH1cblxuICAvLy8gVXRpbGl0aWVzXG5cbiAgZW5kQ29tcG9uZW50KCk6IFtzdHJpbmcsIFN0YXRlbWVudHMuQXR0cmlidXRlW10sIENvcmUuSGFzaCwgT3B0aW9uPFNlcmlhbGl6ZWRJbmxpbmVCbG9jaz5dIHtcbiAgICBsZXQgY29tcG9uZW50ID0gdGhpcy5ibG9ja3MucG9wKCk7XG4gICAgYXNzZXJ0KFxuICAgICAgY29tcG9uZW50IGluc3RhbmNlb2YgQ29tcG9uZW50QmxvY2ssXG4gICAgICAnQ29tcGlsZXIgYnVnOiBlbmRDb21wb25lbnQoKSBzaG91bGQgZW5kIGEgY29tcG9uZW50J1xuICAgICk7XG5cbiAgICByZXR1cm4gKGNvbXBvbmVudCBhcyBDb21wb25lbnRCbG9jaykudG9KU09OKCk7XG4gIH1cblxuICBwdXNoKGFyZ3M6IFN0YXRlbWVudCkge1xuICAgIHdoaWxlIChhcmdzW2FyZ3MubGVuZ3RoIC0gMV0gPT09IG51bGwpIHtcbiAgICAgIGFyZ3MucG9wKCk7XG4gICAgfVxuXG4gICAgdGhpcy5jdXJyZW50QmxvY2sucHVzaChhcmdzKTtcbiAgfVxuXG4gIHB1c2hWYWx1ZTxTIGV4dGVuZHMgRXhwcmVzc2lvbiB8IFBhcmFtcyB8IEhhc2g+KHZhbDogUykge1xuICAgIHRoaXMudmFsdWVzLnB1c2godmFsKTtcbiAgfVxuXG4gIHBvcFZhbHVlPFQgZXh0ZW5kcyBTdGFja1ZhbHVlPigpOiBUIHtcbiAgICBhc3NlcnQodGhpcy52YWx1ZXMubGVuZ3RoLCAnTm8gZXhwcmVzc2lvbiBmb3VuZCBvbiBzdGFjaycpO1xuICAgIHJldHVybiB0aGlzLnZhbHVlcy5wb3AoKSBhcyBUO1xuICB9XG59XG4iXX0=